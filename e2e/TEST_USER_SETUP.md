# テストユーザーのセットアップガイド

## 🔐 テストユーザーとは？

E2Eテストで使用する、**Cognitoに既に登録されているテストアカウント**です。

## ⚠️ 重要な注意事項

- ✅ **既存のCognitoユーザー**が必要です
- ✅ サインイン可能な状態（メール確認済み）
- ✅ 企業情報・管理者情報が設定済み
- ❌ テストのたびに新規作成する必要はありません

---

## 🛠️ セットアップ方法

### 方法1: アプリケーションから作成（推奨）

#### ステップ1: サインアップ

1. 開発サーバーを起動
   ```bash
   npm run dev
   ```

2. ブラウザで以下にアクセス
   ```
   http://localhost:3000/ja/signup/auth
   ```

3. テスト用のメールアドレスとパスワードを入力
   - メール: `test-user@example.com`（実際に受信できるメール）
   - パスワード: `TestPassword123`（8文字以上、大文字・小文字・数字を含む）

4. サインアップを完了

#### ステップ2: メール確認

1. 登録したメールアドレスに確認コードが届く
2. 確認コードを入力して認証を完了

#### ステップ3: 企業情報・管理者情報を設定

1. 企業情報を入力
2. 管理者情報を入力
3. 支払い情報を設定（テストモードのStripeカード番号を使用）
   - カード番号: `4242 4242 4242 4242`
   - 有効期限: 任意の未来の日付
   - CVC: 任意の3桁

#### ステップ4: サインインできることを確認

1. サインアウト
2. サインインページからログイン
3. ダッシュボードが表示されることを確認

#### ステップ5: `.env.test`に情報を記録

プロジェクトルートに`.env.test`ファイルを作成（既に存在する場合は編集）:

```bash
# テストユーザーの認証情報
TEST_EMAIL=test-user@example.com
TEST_PASSWORD=TestPassword123
```

---

### 方法2: AWS Cognitoコンソールから作成

#### ステップ1: Cognitoコンソールにアクセス

1. AWS Management Consoleにログイン
2. Cognitoサービスを開く
3. 使用しているユーザープールを選択

#### ステップ2: ユーザーを作成

1. 「ユーザー」タブを選択
2. 「ユーザーを作成」をクリック
3. 以下の情報を入力:
   - ユーザー名: `test-user@example.com`
   - メールアドレス: `test-user@example.com`
   - 一時パスワード: `TempPassword123`
   - ステータス: **「CONFIRMED」を選択**（重要！）

#### ステップ3: パスワードを設定

1. 作成したユーザーを選択
2. 「アクション」→「パスワードをリセット」
3. 永続的なパスワードを設定: `TestPassword123`

#### ステップ4: 必要な属性を設定

Cognitoコンソールで以下のカスタム属性を設定:
- `custom:customerId`
- `custom:role`
- その他、アプリケーションで必要な属性

#### ステップ5: `.env.test`に情報を記録

```bash
TEST_EMAIL=test-user@example.com
TEST_PASSWORD=TestPassword123
```

---

## 🧪 テストユーザーの確認

### サインインテスト

`.env.test`を設定したら、サインインテストを実行して確認:

```bash
npx playwright test e2e/signin.spec.ts --headed
```

成功すれば、テストユーザーの設定は完了です！

---

## 🔒 セキュリティのベストプラクティス

### ✅ 推奨

1. **専用のテストアカウントを使用**
   - 本番データとは完全に分離
   - テスト用のメールアドレス（例: `test+e2e@yourdomain.com`）

2. **`.env.test`をGitにコミットしない**
   - 既に`.gitignore`に含まれています
   - 認証情報が漏洩しないように注意

3. **テスト環境専用のCognitoユーザープールを使用**
   - 本番環境とは別のユーザープール
   - テストデータの混入を防ぐ

### ❌ 避けるべき

1. **本番ユーザーをテストに使用しない**
2. **実際のクレジットカード情報を使用しない**
3. **認証情報をコードにハードコードしない**

---

## 🔄 テストユーザーのメンテナンス

### データのクリーンアップ

テストで作成されたデータ（ファイル、注文など）は定期的にクリーンアップ:

```bash
# 例: テストユーザーのデータを削除するスクリプト
# npm run cleanup-test-data
```

### パスワードの更新

セキュリティのため、定期的にパスワードを変更:

1. Cognitoコンソールまたはアプリからパスワード変更
2. `.env.test`を更新

---

## 🐛 トラブルシューティング

### エラー: "Incorrect username or password"

**原因**: 
- メールアドレスまたはパスワードが間違っている
- ユーザーが確認されていない（UNCONFIRMED状態）

**解決策**:
1. `.env.test`の認証情報を確認
2. Cognitoコンソールでユーザーのステータスを確認
3. 必要に応じてユーザーを「CONFIRMED」に変更

### エラー: "User does not exist"

**原因**: 
- ユーザーが存在しない
- 異なるユーザープールを参照している

**解決策**:
1. Cognitoコンソールでユーザーが存在することを確認
2. アプリケーションの環境変数（Cognitoユーザープール）を確認

### エラー: "User is not confirmed"

**原因**: 
- メール確認が完了していない

**解決策**:
1. メール確認コードを入力
2. または、Cognitoコンソールでステータスを「CONFIRMED」に変更

---

## 📚 参考情報

### テスト実行コマンド

```bash
# サインインテストのみ
npx playwright test e2e/signin.spec.ts

# 認証が必要なテスト全て
npx playwright test --grep "認証済み"

# UIモードで実行（デバッグに便利）
npx playwright test --ui
```

### 環境変数の確認

```bash
# .env.testの内容を確認（Windows）
type .env.test

# .env.testの内容を確認（Mac/Linux）
cat .env.test
```

---

## ✅ チェックリスト

テストユーザーの準備が完了したら、以下を確認:

- [ ] Cognitoにユーザーが存在する
- [ ] ユーザーのステータスが「CONFIRMED」
- [ ] サインインできることを確認済み
- [ ] 企業情報・管理者情報が設定済み
- [ ] `.env.test`ファイルを作成
- [ ] `.env.test`に正しい認証情報を記載
- [ ] `.env.test`が`.gitignore`に含まれている
- [ ] サインインテストが成功する

---

**準備完了！** 🎉

これで、認証が必要なE2Eテストを実行できます。

